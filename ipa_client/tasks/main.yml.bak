- name: For OTP client registration, add client and get OTP
  become: yes
  freeipa.ansible_freeipa.ipahost:
    state: present
    principal: "{{ ipa_server.principal }}"
    password: "{{ ipa_server.password }}"
    fqdn: "{{ ansible_fqdn }}"
    random: true
  register: ipahost_output
  delegate_to: "{{ groups[ipa_server.group][0] }}"
  when: ipa_server is defined and ipa_client is defined

- name: Configure ipaclient
  become: yes
  freeipa.ansible_freeipa.ipaclient:
    state: present
    domain: "{{ ipa_client.domain }}"
    realm: "{{ ipa_client.realm }}"
    otp: "{{ ipahost_output.host.randompassword }}"
    extra_args: "{{ ipa_client.extraargs }}"
  when: ipa_server is defined and ipa_client is defined

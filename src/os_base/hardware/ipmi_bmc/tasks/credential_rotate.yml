---
- name: Validate new credentials are provided
  ansible.builtin.assert:
    that:
      - bmc_new_ipmi_password | length > 0
    fail_msg: "bmc_new_ipmi_password must be provided for credential rotation"

- name: Set new password for IPMI user
  ansible.builtin.command:
    cmd: >-
      ipmitool -I {{ bmc_ipmi_interface }}
      -H {{ ansible_host }}
      -U {{ bmc_ipmi_username }}
      -P {{ bmc_ipmi_password }}
      user set password {{ bmc_ipmi_user_id }} {{ bmc_new_ipmi_password }}
  delegate_to: "{{ bmc_delegate_host }}"
  changed_when: true
  no_log: true

- name: Set new username for IPMI user
  ansible.builtin.command:
    cmd: >-
      ipmitool -I {{ bmc_ipmi_interface }}
      -H {{ ansible_host }}
      -U {{ bmc_ipmi_username }}
      -P {{ bmc_new_ipmi_password }}
      user set name {{ bmc_ipmi_user_id }} {{ bmc_new_ipmi_username }}
  delegate_to: "{{ bmc_delegate_host }}"
  changed_when: true
  no_log: true
  when: bmc_new_ipmi_username | length > 0

- name: Verify new credentials work
  ansible.builtin.command:
    cmd: >-
      ipmitool -I {{ bmc_ipmi_interface }}
      -H {{ ansible_host }}
      -U {{ bmc_new_ipmi_username | default(bmc_ipmi_username, true) }}
      -P {{ bmc_new_ipmi_password }}
      chassis status
  delegate_to: "{{ bmc_delegate_host }}"
  changed_when: false
  register: bmc_verify_result
  no_log: true

- name: Credential rotation completed
  ansible.builtin.debug:
    msg: >-
      Credential rotation successful for {{ inventory_hostname }}.
      Update bmc_ipmi_username and bmc_ipmi_password in
      group_vars/bmc_supermicro.yml with the new values and re-encrypt with ansible-vault.

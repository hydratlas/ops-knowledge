---
- name: Validate new Redfish credentials are provided
  ansible.builtin.assert:
    that:
      - bmc_new_redfish_password | length > 0
    fail_msg: "bmc_new_redfish_password must be provided for credential rotation"

- name: Update Redfish user password
  community.general.redfish_command:
    category: Accounts
    command: UpdateUserPassword
    baseuri: "{{ ansible_host }}"
    username: "{{ bmc_redfish_username }}"
    password: "{{ bmc_redfish_password }}"
    account_username: "{{ bmc_redfish_username }}"
    account_password: "{{ bmc_new_redfish_password }}"
    validate_certs: "{{ bmc_redfish_validate_certs }}"
  delegate_to: "{{ bmc_delegate_host }}"
  no_log: true

- name: Update Redfish user name
  community.general.redfish_command:
    category: Accounts
    command: UpdateUserName
    baseuri: "{{ ansible_host }}"
    username: "{{ bmc_redfish_username }}"
    password: "{{ bmc_new_redfish_password }}"
    account_username: "{{ bmc_redfish_username }}"
    update_username: "{{ bmc_new_redfish_username }}"
    validate_certs: "{{ bmc_redfish_validate_certs }}"
  delegate_to: "{{ bmc_delegate_host }}"
  no_log: true
  when: bmc_new_redfish_username | length > 0

- name: Verify new Redfish credentials
  community.general.redfish_info:
    category: Accounts
    command: ListUsers
    baseuri: "{{ ansible_host }}"
    username: "{{ bmc_new_redfish_username | default(bmc_redfish_username, true) }}"
    password: "{{ bmc_new_redfish_password }}"
    validate_certs: "{{ bmc_redfish_validate_certs }}"
  delegate_to: "{{ bmc_delegate_host }}"
  register: _redfish_users
  no_log: true

- name: Credential rotation completed (Redfish)
  ansible.builtin.debug:
    msg: >-
      Credential rotation successful for {{ inventory_hostname }}.
      Update bmc_redfish_username and bmc_redfish_password in
      host_vars/<hostname>.yml with the new values and re-encrypt with ansible-vault.

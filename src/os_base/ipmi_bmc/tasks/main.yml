---
- name: Validate bmc_protocol value
  ansible.builtin.assert:
    that:
      - bmc_protocol in ['ipmi', 'redfish']
    fail_msg: "bmc_protocol must be 'ipmi' or 'redfish', got '{{ bmc_protocol }}'"
  tags: always

# ── IPMI 事前準備 ─────────────────────────────────────
- name: Gather facts on delegate host
  ansible.builtin.setup:
    gather_subset: min
  delegate_to: "{{ bmc_delegate_host }}"
  delegate_facts: true
  run_once: true
  when: bmc_protocol == 'ipmi'
  tags: always

- name: Ensure ipmitool is installed on delegate host
  ansible.builtin.package:
    name: ipmitool
    state: present
  delegate_to: "{{ bmc_delegate_host }}"
  run_once: true
  become: true
  when: bmc_protocol == 'ipmi'
  tags: always

# ── 電源操作 ──────────────────────────────────────────
- name: Execute power operation (IPMI)
  ansible.builtin.include_tasks:
    file: power.yml
    apply:
      tags: bmc_power
  when: bmc_protocol == 'ipmi'
  tags: bmc_power

- name: Execute power operation (Redfish)
  ansible.builtin.include_tasks:
    file: power_redfish.yml
    apply:
      tags: bmc_power
  when: bmc_protocol == 'redfish'
  tags: bmc_power

# ── ブートデバイス設定 ────────────────────────────────
- name: Set boot device (IPMI)
  ansible.builtin.include_tasks:
    file: boot_device.yml
    apply:
      tags: bmc_boot
  when: bmc_protocol == 'ipmi'
  tags: bmc_boot

- name: Set boot device (Redfish)
  ansible.builtin.include_tasks:
    file: boot_device_redfish.yml
    apply:
      tags: bmc_boot
  when: bmc_protocol == 'redfish'
  tags: bmc_boot

# ── 認証情報ローテーション ────────────────────────────
- name: Rotate credentials (IPMI)
  ansible.builtin.include_tasks:
    file: credential_rotate.yml
    apply:
      tags: bmc_credential
  when:
    - bmc_protocol == 'ipmi'
    - bmc_rotate_credentials | bool
  tags: bmc_credential

- name: Rotate credentials (Redfish)
  ansible.builtin.include_tasks:
    file: credential_rotate_redfish.yml
    apply:
      tags: bmc_credential
  when:
    - bmc_protocol == 'redfish'
    - bmc_rotate_credentials | bool
  tags: bmc_credential

# ── ハードウェアインベントリ（Redfish 専用）──────────
- name: Skip hardware inventory (IPMI does not support this feature)
  ansible.builtin.debug:
    msg: "Hardware inventory is only available with Redfish protocol"
  when: bmc_protocol == 'ipmi'
  tags: bmc_inventory

- name: Collect hardware inventory (Redfish)
  ansible.builtin.include_tasks:
    file: inventory_redfish.yml
    apply:
      tags: bmc_inventory
  when: bmc_protocol == 'redfish'
  tags: bmc_inventory

# ── ヘルスチェック（Redfish 専用）──────────────────
- name: Skip health check (IPMI does not support this feature)
  ansible.builtin.debug:
    msg: "Health check is only available with Redfish protocol"
  when: bmc_protocol == 'ipmi'
  tags: bmc_health

- name: Collect health report (Redfish)
  ansible.builtin.include_tasks:
    file: health_redfish.yml
    apply:
      tags: bmc_health
  when: bmc_protocol == 'redfish'
  tags: bmc_health

# ── センサーデータ（Redfish 専用）──────────────────
- name: Skip sensor data (IPMI does not support this feature)
  ansible.builtin.debug:
    msg: "Sensor data collection is only available with Redfish protocol"
  when: bmc_protocol == 'ipmi'
  tags: bmc_sensors

- name: Collect sensor data (Redfish)
  ansible.builtin.include_tasks:
    file: sensors_redfish.yml
    apply:
      tags: bmc_sensors
  when: bmc_protocol == 'redfish'
  tags: bmc_sensors

# ── ファームウェアバージョン（Redfish 専用）────────
- name: Skip firmware inventory (IPMI does not support this feature)
  ansible.builtin.debug:
    msg: "Firmware inventory is only available with Redfish protocol"
  when: bmc_protocol == 'ipmi'
  tags: bmc_firmware

- name: Collect firmware inventory (Redfish)
  ansible.builtin.include_tasks:
    file: firmware_redfish.yml
    apply:
      tags: bmc_firmware
  when: bmc_protocol == 'redfish'
  tags: bmc_firmware

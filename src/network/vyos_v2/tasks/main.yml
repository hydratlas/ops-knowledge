- name: Validate vyos_v2 required variables
  ansible.builtin.assert:
    that:
      - vyos_v2_hostname is defined
      - vyos_v2_health_check_gateway is defined
      - vyos_v2_firewall is defined
      - vyos_v2_vrrp is defined
      - vyos_v2_interfaces is defined
      - vyos_v2_nat is defined
      - vyos_v2_conntrack_sync is defined
      - vyos_v2_dhcp_server is defined
      - vyos_v2_dns_forwarding is defined
      - vyos_v2_ntp is defined
      - vyos_v2_ssh is defined
      - vyos_v2_system is defined
      - vyos_v2_containers is defined
      - vyos_v2_static_routes is defined
    fail_msg: "Required vyos_v2_ variables are not defined"

- name: Create VRRP health check script
  ansible.builtin.copy:
    dest: /config/scripts/check-gateway.sh
    mode: "0755"
    content: |
      #!/bin/sh
      ping -c 1 -W 2 {{ vyos_v2_health_check_gateway }} > /dev/null 2>&1
  become: true
  vars:
    ansible_connection: ansible.builtin.ssh

- name: Get current configuration commands
  vyos.vyos.vyos_command:
    commands:
      - show configuration commands
  register: vyos_v2_current_raw
  check_mode: false

- name: Generate desired set commands from templates
  ansible.builtin.set_fact:
    vyos_v2_desired_commands: >-
      {{ lookup('template', 'config_commands.j2')
         | split('\n')
         | reject('match', '^\s*$')
         | reject('match', '^\s*\{#')
         | reject('match', '.*authentication (plaintext-password|encrypted-password)')
         | map('trim')
         | map('regex_replace', "'", '')
         | sort | list }}

- name: Filter current commands to managed sections
  ansible.builtin.set_fact:
    vyos_v2_current_commands: >-
      {{ vyos_v2_current_raw.stdout_lines[0]
         | select('match', vyos_v2_managed_regex)
         | reject('match', '.*authentication (plaintext-password|encrypted-password)')
         | map('trim')
         | map('regex_replace', "'", '')
         | sort | list }}

- name: Determine if configuration has changed
  ansible.builtin.set_fact:
    vyos_v2_config_changed: "{{ vyos_v2_desired_commands != vyos_v2_current_commands }}"

- name: Show configuration diff
  ansible.builtin.debug:
    msg:
      commands_to_add: "{{ vyos_v2_desired_commands | difference(vyos_v2_current_commands) }}"
      commands_to_remove: "{{ vyos_v2_current_commands | difference(vyos_v2_desired_commands) }}"
  when: vyos_v2_config_changed | bool
  changed_when: false

- name: Build apply commands (delete + set)
  ansible.builtin.set_fact:
    vyos_v2_apply_commands: >-
      {{ vyos_v2_delete_commands +
         (lookup('template', 'config_commands.j2')
          | split('\n')
          | reject('match', '^\s*$')
          | reject('match', '^\s*\{#')
          | map('trim')
          | map('regex_replace', "'", '')
          | list) }}
  when: vyos_v2_config_changed | bool

- name: Apply configuration
  vyos.vyos.vyos_config:
    lines: "{{ vyos_v2_apply_commands }}"
    match: none
    save: true
  when: vyos_v2_config_changed | bool

---
# unified_mounts - 統合マウント管理ロール
#
# サポートする変数形式:
#   1. unified_mounts: 直接リスト形式
#   2. unified_mount_patterns + unified_mount_selectors: パターン/セレクタ形式

# マウントリストの構築
- name: Build unified mount list
  ansible.builtin.set_fact:
    _unified_mounts_combined: >-
      {{
        (unified_mounts | default([])) +
        (unified_mount_patterns | default({}) | dict2items
          | selectattr('key', 'in', unified_mount_selectors | default([]))
          | map(attribute='value')
          | list)
      }}

# 必要なパッケージのインストール（NFS）
- name: Install NFS client package on Debian-based systems
  ansible.builtin.package:
    name: nfs-common
    state: present
  when:
    - _unified_mounts_combined | selectattr('fstype', 'in', ['nfs', 'nfs4']) | list | length > 0
    - ansible_facts['os_family'] == 'Debian'

- name: Install NFS client package on RHEL-based systems
  ansible.builtin.package:
    name: nfs-utils
    state: present
  when:
    - _unified_mounts_combined | selectattr('fstype', 'in', ['nfs', 'nfs4']) | list | length > 0
    - ansible_facts['os_family'] == 'RedHat'

# 必要なパッケージのインストール（CIFS）
- name: Install CIFS client package on Debian-based systems
  ansible.builtin.package:
    name: cifs-utils
    state: present
  when:
    - _unified_mounts_combined | selectattr('fstype', 'equalto', 'cifs') | list | length > 0
    - ansible_facts['os_family'] == 'Debian'

- name: Install CIFS client package on RHEL-based systems
  ansible.builtin.package:
    name: cifs-utils
    state: present
  when:
    - _unified_mounts_combined | selectattr('fstype', 'equalto', 'cifs') | list | length > 0
    - ansible_facts['os_family'] == 'RedHat'

# マウントポイントディレクトリの作成
- name: Ensure mount points exist
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode | default('0755') }}"
  loop: "{{ _unified_mounts_combined }}"
  when: item.state | default('mounted') != 'absent'

# マウントの設定と実行
- name: Configure and execute mounts
  ansible.builtin.mount:
    path: "{{ item.path }}"
    src: "{{ item.src }}"
    fstype: "{{ item.fstype }}"
    opts: "{{ item.opts | default(omit) }}"
    dump: "{{ item.dump | default(0) }}"
    passno: "{{ item.passno | default(0) }}"
    state: "{{ item.state | default('mounted') }}"
  loop: "{{ _unified_mounts_combined }}"

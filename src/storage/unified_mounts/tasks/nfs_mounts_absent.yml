---
# 削除対象のautomountユニットを停止・無効化
- name: Stop and disable NFS automount units for absent mounts
  ansible.builtin.systemd:
    name: "{{ item.path | regex_replace('^/', '') | regex_replace('/', '-') }}.automount"
    state: stopped
    enabled: false
  loop: "{{ _unified_mounts_nfs | selectattr('state', 'defined') | selectattr('state', 'equalto', 'absent') | list }}"
  failed_when: false
  when: not _unified_mounts_is_lxc

# 対応するmountユニットも停止（LXCではこちらのみ存在する）
- name: Stop NFS mount units for absent mounts
  ansible.builtin.systemd:
    name: "{{ item.path | regex_replace('^/', '') | regex_replace('/', '-') }}.mount"
    state: stopped
  loop: "{{ _unified_mounts_nfs | selectattr('state', 'defined') | selectattr('state', 'equalto', 'absent') | list }}"
  failed_when: false

# automountユニットファイルを削除（LXCにはautomountがないためスキップ）
- name: Remove NFS automount unit files for absent mounts
  ansible.builtin.file:
    path: "/etc/systemd/system/{{ item.path | regex_replace('^/', '') | regex_replace('/', '-') }}.automount"
    state: absent
  loop: "{{ _unified_mounts_nfs | selectattr('state', 'defined') | selectattr('state', 'equalto', 'absent') | list }}"
  notify: Reload systemd daemon
  when: not _unified_mounts_is_lxc

# mountユニットファイルを削除（全環境共通）
- name: Remove NFS mount unit files for absent mounts
  ansible.builtin.file:
    path: "/etc/systemd/system/{{ item.path | regex_replace('^/', '') | regex_replace('/', '-') }}.mount"
    state: absent
  loop: "{{ _unified_mounts_nfs | selectattr('state', 'defined') | selectattr('state', 'equalto', 'absent') | list }}"
  notify: Reload systemd daemon

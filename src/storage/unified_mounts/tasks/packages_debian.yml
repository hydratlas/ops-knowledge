---
# NFSマウント定義時にnfs-commonを導入
- name: Install NFS client package
  ansible.builtin.apt:
    name: nfs-common
    state: present
  when: _unified_mounts_nfs | length > 0

# fscオプション使用時にFS-Cacheデーモンを導入・設定
- name: Configure FS-Cache (cachefilesd)
  when: _unified_mounts_uses_fsc
  block:
    # FS-Cacheデーモンを導入
    - name: Install cachefilesd package
      ansible.builtin.apt:
        name: cachefilesd
        state: present

    # cachefilesdがデフォルト無効のためRUN=yesで有効化
    - name: Enable cachefilesd in /etc/default/cachefilesd
      ansible.builtin.lineinfile:
        path: /etc/default/cachefilesd
        regexp: '^#?RUN='
        line: RUN=yes
        create: true
        mode: "0644"
      notify: Restart cachefilesd

    # cachefilesdの起動待機時間を短縮（デフォルト30秒→2秒）
    - name: Set STARTTIME for cachefilesd
      ansible.builtin.lineinfile:
        path: /etc/default/cachefilesd
        regexp: '^#?STARTTIME='
        line: STARTTIME=2
        create: true
        mode: "0644"
      notify: Restart cachefilesd

# CIFSマウント定義時にcifs-utilsを導入
- name: Install CIFS client package
  ansible.builtin.apt:
    name: cifs-utils
    state: present
  when: _unified_mounts_non_nfs | selectattr('fstype', 'equalto', 'cifs') | list | length > 0

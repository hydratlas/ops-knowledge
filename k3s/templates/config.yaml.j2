# k3s configuration file
# {{ ansible_managed }}

{% if k3s_server_or_agent == "agent" and k3s_server_url %}
server: {{ k3s_server_url }}
{% endif %}

{% if k3s_token %}
token: {{ k3s_token }}
{% endif %}

{% if k3s_config %}
{% for key, value in k3s_config.items() %}
{% if value is string or value is number or value is boolean %}
{{ key }}: {{ value }}
{% elif value is iterable and value is not mapping %}
{{ key }}:
{% for item in value %}
  - {{ item }}
{% endfor %}
{% elif value is mapping %}
{{ key }}:
{% for subkey, subvalue in value.items() %}
  {{ subkey }}: {{ subvalue }}
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}

# Data directory
data-dir: {{ k3s_data_dir }}

# Log directory (if specified)
{% if k3s_log_dir %}
log: {{ k3s_log_dir }}/k3s.log
{% endif %}

# Node labels (optional)
{% if k3s_node_labels is defined %}
node-label:
{% for label in k3s_node_labels %}
  - {{ label }}
{% endfor %}
{% endif %}

# Node taints (optional)
{% if k3s_node_taints is defined %}
node-taint:
{% for taint in k3s_node_taints %}
  - {{ taint }}
{% endfor %}
{% endif %}